on:
  - push
  - delete
  - pull_request

jobs:
  compile:
    runs-on: self-hosted
    name: Compile
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
      #timeout 1h
      - name: Configure Arduino CLI
        run: arduino-cli config set network.connection_timeout 6000s
      - name: Install dependencies
        run: |
          deps=$(grep "^depends=" library.properties | cut -d'=' -f2)
          IFS=',' read -ra ADDR <<< "$deps"
          for i in "${ADDR[@]}"; do
            lib=$(echo "$i" | xargs)
            if [ -n "$lib" ]; then
              echo "Installing $lib..."
              arduino-cli lib install "$lib" || echo "Failed to install $lib"
              arduino-cli lib upgrade "$lib" || echo "Failed to upgrade $lib"
            fi
          done
      - name: install Board
        run: | 
          arduino-cli core install esp32:esp32
          arduino-cli core upgrade esp32:esp32
          arduino-cli core list
      - name: install dezibot
        run: |
          git archive --format=zip --prefix=dezibot/ --output=dezibot.zip HEAD
          arduino-cli lib uninstall dezibot || echo "Dezibot was not installed"
          arduino-cli config set library.enable_unsafe_install true
          arduino-cli lib install --zip-path dezibot.zip
          arduino-cli config set library.enable_unsafe_install false
      - name: Compile
        run: | 
          mkdir test
          wget ${{ vars.OVERALL_TEST }} -O test/test.ino
          arduino-cli compile --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino 

  RGBLED:
    runs-on: self-hosted
    name: RGB LED Test
    needs: compile
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
      - name: prepare test
        run: ${{secrets.INSTALL_AND_PREPARE}}
      - name: Compile and Upload
        run: | 
          mkdir test
          wget ${{ vars.RGB_TEST }} -O test/test.ino
          arduino-cli compile --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino 
          arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino
      - name: Monitor RGB Test
        shell: bash
        run: | 
          cat > monitor.sh << 'SCRIPT'
            ${{vars.MONITOR_SCRIPT}}
          SCRIPT
          chmod +x monitor.sh
          bash monitor.sh
      - name: Upload Artefact
        uses: actions/upload-artifact@v4
        with:
          name: rgb-test-log
          path: rgb_test_output.log
    # Last line of test shows whether it passed or failed with: "Test: PASSED" or "Test: FAILED"
      - name: check test result
        run: |
          if grep -q "Test: PASSED" rgb_test_output.log; then
            echo "Test: PASSED"
          else
            echo "Test: FAILED"
            exit 1
          fi

  InfraredLED:
    runs-on: self-hosted
    name: Infrared LED and Transistors Test
    needs: RGBLED
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
      - name: prepare test
        run: ${{secrets.INSTALL_AND_PREPARE}}
      - name: Compile and Upload
        run: | 
          mkdir test
          wget ${{ vars.IR_TEST }} -O test/test.ino
          arduino-cli compile --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino 
          arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino
      - name: Monitor IR Test
        shell: bash
        run: ${{ vars.MONITOR_SCRIPT }}
      - name: Upload Artefact
        uses: actions/upload-artifact@v4
        with:
          name: ir-test-log
          path: ir_test_output.log
    # Last line of test shows whether it passed or failed with: "Test: PASSED" or "Test: FAILED"
      - name: check test result
        run: |
          if grep -q "Test: PASSED" ir_test_output.log; then
            echo "Test: PASSED"
          else
            echo "Test: FAILED"
            exit 1
          fi
  
  IMU_Motors:
    runs-on: self-hosted
    name: IMU and Motors Test
    needs: RGBLED
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
      - name: prepare test
        run: ${{secrets.INSTALL_AND_PREPARE}}
      - name: Compile and Upload
        run: | 
          mkdir test
          wget ${{ vars.IMU_TEST }} -O test/test.ino
          arduino-cli compile --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino 
          arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino
      - name: Monitor IMU and Motors Test
        shell: bash
        run: ${{ vars.MONITOR_SCRIPT }}
      - name: Upload Artefact
        uses: actions/upload-artifact@v4
        with:
          name: imu-test-log
          path: imu_test_output.log
    # Last line of test shows whether it passed or failed with: "Test: PASSED" or "Test: FAILED"
      - name: check test result
        run: |
          if grep -q "Test: PASSED" imu_test_output.log; then
            echo "Test: PASSED"
          else
            echo "Test: FAILED"
            exit 1
          fi
        
  Batterie:
    runs-on: self-hosted
    name: Batterie and Power Test
    needs: RGBLED
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
      - name: prepare test
        run: ${{secrets.INSTALL_AND_PREPARE}}
      - name: Compile and Upload
        run: | 
          mkdir test
          wget ${{vars.BATTERIE_TEST}} -O test/test.ino
          arduino-cli compile --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino 
          arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32s3usbotg:USBMode=hwcdc,PartitionScheme=default,DebugLevel=none,EraseFlash=none test/test.ino
      - name: Monitor Batterie Test
        shell: bash
        run: |
          set -euo pipefail
          stty -F /dev/ttyACM0 115200 -echo -icanon min 1 time 0 -crtscts -ixon -ixoff -hupcl

          # Pipeline/Fehlerbehandlung temporär aus
          set +e
          set +o pipefail

          /usr/bin/timeout --preserve-status --signal=SIGINT --kill-after=2s 120s \
            bash -lc 'exec stdbuf -i0 -o0 -e0 cat /dev/ttyACM0 | stdbuf -i0 -o0 -e0 tee -a batterie_test_output.log'
          rc=$?
          set -o pipefail
          set -e
          case "$rc" in
            0)   echo "Serial finished cleanly."; exit 0 ;;
            124) echo "Timeout after 120s (expected)."; exit 0 ;;   # timeout
            130) echo "Ended by SIGINT as intended (exit 130)."; exit 0 ;;
            137) echo "Force-killed after 2s grace (SIGKILL, exit 137)."; exit 0 ;;
            *)   echo "Unexpected exit code $rc — treating as success for CI."; exit 0 ;;
          esac
      - name: Upload Artefact
        uses: actions/upload-artifact@v4
        with:
          name: batterie-test-log
          path: batterie_test_output.log
    # Last line of test shows whether it passed or failed with: "Test: PASSED" or "Test: FAILED"
      - name: check test result
        run: |
          if grep -q "Test: PASSED" batterie_test_output.log; then
            echo "Test: PASSED"
          else
            echo "Test: FAILED"
            exit 1
          fi

  sync:
    runs-on: self-hosted
    name: Git Repo Sync
    needs: [RGBLED, InfraredLED, IMU_Motors, Batterie]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: wangchucheng/git-repo-sync@v0.1.0
        with:
          target-url: ${{ secrets.TARGET_URL }}
          target-username: ${{ secrets.TARGET_USERNAME }}
          target-token:  ${{ secrets.TARGET_TOKEN }}
